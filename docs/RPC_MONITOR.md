# RPC合约监控器

## 概述

RPC合约监控器是一个稳定的、基于HTTP轮询的Hyperliquid合约交易监控解决方案，专门设计用来解决WebSocket连接不稳定和大订单子成交重复警报的问题。

## 核心特性

### 🔄 HTTP轮询策略
- **稳定性**: 避免WebSocket连接频繁断线问题
- **可靠性**: 使用Hyperliquid官方HTTP API，稳定性更高
- **可控性**: 轮询间隔可配置，默认15秒一次

### 🎯 订单聚合机制
- **智能聚合**: 自动识别同一订单ID(oid)的多个子成交
- **时间窗口**: 5秒内的子成交会被聚合为一个警报
- **加权平均**: 计算聚合订单的加权平均价格
- **完整信息**: 保留原始子成交数量和聚合时间跨度

### 📊 地址验证
- **严格匹配**: 验证每个填充事件的用户地址，避免误报
- **数据完整性**: 验证必要字段存在性
- **资产过滤**: 自动跳过现货交易(@开头的资产)

### 🔍 实时监控
- **独立轮询**: 每个交易员独立轮询线程
- **错误恢复**: 连续错误自动增加重试间隔
- **健康监控**: 实时监控系统健康状态和统计信息

## 解决的问题

### 1. WebSocket连接不稳定
**问题**: WebSocket连接经常断线，重连机制复杂且不可靠
**解决**: 使用HTTP轮询，每次请求都是独立的，避免连接状态问题

### 2. 大订单子成交重复警报
**问题**: 一个4.22094 BTC的大订单会分解成几百个小订单，产生大量重复警报
**解决**: 
- 通过订单ID(oid)识别同一母订单的子成交
- 5秒时间窗口内聚合所有子成交
- 计算聚合后的总量和加权平均价格
- 只发送一个聚合后的警报

### 3. 地址映射错误
**问题**: 收到错误交易员的警报，地址映射不正确
**解决**:
- 严格验证每个填充事件的用户地址
- 只处理匹配指定交易员地址的事件
- 详细的调试日志记录地址匹配过程

## 配置说明

### 环境变量
```bash
# 启用RPC监控器
CONTRACT_MONITOR_TYPE=rpc

# 合约监控基本配置
CONTRACT_MONITORING_ENABLED=true
CONTRACT_MIN_NOTIONAL=100  # 最小名义价值阈值
```

## 与WebSocket方案对比

| 特性 | RPC监控器 | WebSocket监控器 |
|------|-----------|-----------------|
| 连接稳定性 | ✅ 优秀 | ❌ 经常断线 |
| 子订单处理 | ✅ 智能聚合 | ❌ 重复警报 |
| 地址验证 | ✅ 严格验证 | ⚠️ 容易误报 |
| 实时性 | ⚠️ 15秒延迟 | ✅ 实时 |
| 资源消耗 | ✅ 低 | ⚠️ 中等 |
| 开发复杂度 | ✅ 简单 | ❌ 复杂 |
| 错误恢复 | ✅ 自动恢复 | ❌ 需要重启 |

## 使用方法

### 启动监控器
```typescript
const monitor = new RpcContractMonitor(traders, minNotionalValue);

monitor.on('contractEvent', (event, trader) => {
  console.log('收到合约事件:', {
    trader: trader.label,
    asset: event.asset,
    size: event.size,
    side: event.side,
    isAggregated: event.metadata?.isAggregated
  });
});

await monitor.start();
```

## 总结

RPC合约监控器通过HTTP轮询和智能订单聚合，有效解决了WebSocket方案的稳定性问题和大订单重复警报问题。它提供了可靠的交易监控能力，特别适合需要稳定性高于实时性的监控场景。

主要优势：
- ✅ 解决连接稳定性问题
- ✅ 智能处理大订单子成交
- ✅ 严格的地址验证避免误报
- ✅ 完善的错误恢复机制
- ✅ 详细的监控指标和日志
